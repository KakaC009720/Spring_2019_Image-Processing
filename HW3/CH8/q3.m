a=[  8 17  4 10 15 12
    10 12 15  7  3 10
    15 10 50  5  3 12
     4  8 11  4  1  8
    16  7  4  3  0  7
    16 24 19  3 20 10];
av=[1 1 1;1 0 1;1 1 1]/8;
aav=imfilter(a,av);
D=0.5;
r=abs(a-aav)>D;
r2=(r.*aav+(1-r).*a);
r2